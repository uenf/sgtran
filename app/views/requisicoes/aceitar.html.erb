<%= javascript_include_tag :defaults %>
<%= javascript_include_tag "viagem_nova_existente.js" %>
<%= calendar_date_select_includes "silver", :locale => "pt"%>
<%= javascript_include_tag "calendar_date_select/format_italian" %>


<div class="show_padrao">

        <!---------------------------------------------------------------------------->

  <div class="formularios_embutidos">
  <% form_tag :controller => "requisicoes", :action => "fechar_viagem", :id => @requisicao.id do %>
    <fieldset>
      <legend>Detalhes da viagem</legend>
      <%= mensagem_de_erro(@viagem) %>
      <%= mensagem_de_erro @requisicao %>

      <div id="viagem_nova_existente">
        <fieldset>
          <legend>Atender com uma viagem:</legend>
            <%= radio_button_tag :escolha_de_viagem, "nova", true, :onclick => "viagemNovaOuExistente()" %>
            <%= label_tag :escolha_de_viagem_nova, "Nova: ", :id => "label_viagem_nova" %>
            <br class="pular_linha"/>

            <%= radio_button_tag :escolha_de_viagem, "existente", false, :onclick => "viagemNovaOuExistente()" %>
            <%= label_tag :escolha_de_viagem_existente, "Existente: ", :id => "label_viagem_existente" %>
            <br class="pular_linha"/>
        </fieldset>
        <fieldset>
          <legend>Dados para envio de E-mail</legend>
          <%= label_tag "corpo_do_email", "Corpo do E-mail:" %>
          <%= text_area_tag "corpo_do_email" %>
          <br class="pular_linha" />
          <%= label_tag "destinatarios", "Destinat&aacute;rios:" %>
          <%= text_field_tag "destinatarios" %>
        </fieldset>
      </div>
      <!-- VIAGEM NOVA ----------------------------------------------------- -->
      <div id="viagem_nova">
      <fieldset>
        <legend>Dados da nova viagem:</legend>
          <label for="viagem_data_de_saida">Data de sa&iacute;da:</label>
          <%= calendar_date_select_tag "viagem_data_de_saida",
                                      @viagem.data_partida ? @viagem.data_partida.to_date.to_s_br : "",
                                      :name => "data_saida",
                                      :year_range => [0.years.ago, 2.years.from_now],
                                      :month_year => "label",
                                      :class => "campo_data"%> <br class="pular_linha"/>

          <%= observe_field :viagem_data_de_saida,
                            :url => { :controller => :requisicoes,
                              :action => :opcoes_motoristas },
                            :update => :motorista_id,
                            :with => "'data_partida=' + document.getElementById('viagem_data_de_saida').value + '&data_chegada=' + document.getElementById('viagem_data_de_chegada').value"
                            %>

          <%= observe_field :viagem_data_de_saida,
                            :url => { :controller => :requisicoes,
                              :action => :opcoes_veiculos },
                            :update => :veiculo_id,
                            :with => "'data_partida=' + document.getElementById('viagem_data_de_saida').value + '&data_chegada=' + document.getElementById('viagem_data_de_chegada').value + '&categoria_de_veiculo_id=' + '#{@requisicao.categoria_de_veiculo_id}'"
                            %>

          <label for="viagem_data_de_chegada">Data de chegada:</label>
          <%= calendar_date_select_tag "viagem_data_de_chegada",
                                      @viagem.data_chegada ? @viagem.data_chegada.to_date.to_s_br : "",
                                      :name => "data_chegada",
                                      :year_range => [0.years.ago, 2.years.from_now],
                                      :month_year => "label",
                                      :class => "campo_data"%>
          <br class="pular_linha"/>

          <%= observe_field :viagem_data_de_chegada,
                            :url => { :controller => :requisicoes,
                              :action => :opcoes_motoristas },
                            :update => :motorista_id,
                            :with => "'data_partida=' + document.getElementById('viagem_data_de_saida').value + '&data_chegada=' + document.getElementById('viagem_data_de_chegada').value"
                            %>

          <%= observe_field :viagem_data_de_chegada,
                            :url => { :controller => :requisicoes,
                              :action => :opcoes_veiculos },
                            :update => :veiculo_id,
                            :with => "'data_partida=' + document.getElementById('viagem_data_de_saida').value + '&data_chegada=' + document.getElementById('viagem_data_de_chegada').value + '&categoria_de_veiculo_id=' + '#{@requisicao.categoria_de_veiculo_id}'"
                            %>

          <label for="horario_partida">Hor&aacute;rio de sa&iacute;da:</label>
          <%= time_select :horario, :partida, {:time_separator => ':', :minute_step => 5, :include_blank => "-"}%>
          <br class="pular_linha"/>

          <label for="motorista_id" class ="label_obrigatorio">Motorista:</label>
          <select name="motorista_id" id="motorista_id">
            <%= grouped_options_for_select(@lista_motoristas, "", "Selecione um motorista") %>
          </select>
          <br class="pular_linha"/>


          <label for="veiculo_id">Ve&iacute;culo:</label>
          <select name="veiculo_id" id="veiculo_id">
            <%= grouped_options_for_select(@lista_veiculos, "", "Selecione um ve&iacute;culo") %>
          </select>
          <br class="pular_linha"/>
        </fieldset>


      </div>


      <!-- VIAGEM EXISTENTE ------------------------------------------------ -->
      <div id="viagens_existentes" class="invisivel">
        <table id="viagens" class="tabela_padrao">
          <tr>
            <th>Data de partida</th>
            <th>Data de chegada</th>
            <th>Hor&aacute;rio de partida</th>
            <th>Motorista</th>
            <th>Ve&iacute;culo</th>
            <th>Requisi&ccedil;&atilde;o(s) atendida(s)</th>
            <th>Escolha</th>
          </tr>

        <% @viagens.each do |viagem|%>
          <% (veiculo = Veiculo.find(viagem.veiculo_id)) if viagem.veiculo_id%>
          <tr>
            <td><%=h (viagem.data_partida.strftime("%d/%m/%Y")) if viagem.data_partida %></td>
            <td><%=h (viagem.data_chegada.strftime("%d/%m/%Y")) if viagem.data_chegada %></td>
            <td><%=h (viagem.horario_partida.strftime("%H : %M")) if (viagem.horario_partida) %></td>
            <td><%=h (viagem.motorista.nome) if viagem.motorista  %></td>
            <td>
              <%=h CategoriaDeVeiculo.find(veiculo.categoria_de_veiculo_id).nome +
                " - " + veiculo.modelo + " - " + veiculo.placa if veiculo%>
            </td>
            <td><%=h viagem.requisicoes_atendidas.to_sentence %></td>
            <td><%= radio_button_tag :id_da_viagem, viagem.id, false%></td>
          </tr>

        <% end %>

        </table>
      </div>

      <%= submit_tag "Concluir", :class => "botao_concluir" %>

    </fieldset>
  <% end %>

  </div>

        <!---------------------------------------------------------------------------->

    <h1>Dados do solicitante</h1>

    <div class="show_linha">
      <div class="linha_titulo"> Matricula: </div> <div class="linha_texto"> <%=h @solicitante.matricula %> </div>
    </div>

    <div class="show_linha">
      <div class="linha_titulo"> Nome do solicitante: </div> <div class="linha_texto"> <%=h @solicitante.nome %> </div>
    </div>

    <div class="show_linha">
      <div class="linha_titulo"> Email: </div> <div class="linha_texto"> <%=h @solicitante.email %> </div>
    </div>

    <div class="show_linha">
      <div class="linha_titulo"> Cargo: </div> <div class="linha_texto"> <%=h @solicitante.cargo %> </div>
    </div>

    <div class="show_linha">
      <div class="linha_titulo"> Telefone ou ramal: </div> <div class="linha_texto"> <%=h @solicitante.telefone_ou_ramal %> </div>
    </div>

    <div class="show_linha">
      <div class="linha_titulo"> Celular: </div> <div class="linha_texto"> <%=h @requisicao.celular %> </div>
    </div>

    <div class="show_linha">
      <div class="linha_titulo"> Lab. ou setor: </div> <div class="linha_texto"> <%=h @solicitante.laboratorio_ou_setor %> </div>
    </div>

    <div class="show_linha">
      <div class="linha_titulo"> Centro: </div> <div class="linha_texto"> <%=h Centro.find(@solicitante.centro_id).nome %> </div>
    </div>

    <h1>Dados da reserva</h1>

    <div class="show_linha">
      <div class="linha_titulo"> Data de reserva: </div> <div class="linha_texto"> <%=h @requisicao.data_de_reserva.strftime("%d/%m/%Y")%> </div>
    </div>

    <div class="show_linha">
      <div class="linha_titulo"> Categoria do ve&iacute;culo: </div> <div class="linha_texto"> <%=h CategoriaDeVeiculo.find(@requisicao.categoria_de_veiculo_id).nome %> </div>
    </div>

    <div class="show_linha">
      <div class="linha_titulo"> Objetivo da reserva: </div> <div class="linha_texto"> <%=h ObjetivoDeReserva.find(@requisicao.objetivo_de_reserva_id).texto %> </div>
    </div>

    <div class="show_linha">
      <div class="linha_titulo"> Outros: </div> <div class="linha_texto"> <%=h @requisicao.outros %> </div>
    </div>

    <div class="show_linha">
      <div class="linha_titulo"> Nome e telefone dos passageiros: </div> <div class="linha_texto"> <%=h @requisicao.nome_telefone_passageiros %> </div>
    </div>

    <div class="show_linha">
      <div class="linha_titulo"> Roteiro da agenda (ida): </div> <div class="linha_texto"> <%=h @requisicao.roteiro_da_agenda %> </div>
    </div>

    <div class="show_linha">
      <div class="linha_titulo"> Observacao: </div> <div class="linha_texto"> <%=h @requisicao.observacao %> </div>
    </div>

    <div class="show_linha">
      <div class="linha_titulo"> Estado: </div> <div class="linha_texto"> <%=h @requisicao.estado.to_s %> </div>
    </div>

</div>

<!---------------------------------------------------------------------------->

<div id="opcoes_da_visao">
  <ul>
    <li id="opcao_voltar" onclick="history.back(-1)" onmouseover="this.style.cursor='pointer'">Voltar</li>
  </ul>
  <div class="pular_linha"></li>
</div>

