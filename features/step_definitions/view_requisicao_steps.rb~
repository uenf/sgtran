require File.expand_path(File.join(File.dirname(__FILE__), "..", "support", "paths"))
require "factory_girl"

Given /^que eu tenha ([0-9]+) requisições em espera$/ do |quantidade|
  for pos in (1..quantidade.to_i) do
    solicitante = Factory.create :solicitante, :nome => 'fulano ' + pos.to_s
    requisicao = Factory.create :requisicao, :id => pos, :solicitante_id => solicitante.id
  end
end

Then /^eu devo ver a tabela "(.+)" com$/ do |tabela_id, tabela_esperada|
  tabela_esperada.diff!(table_at("#" + tabela_id).to_a)
end

When /^eu aceito a requisição ([0-9]+)$/ do |requisicao_id|
  requisicao = Requisicao.find(requisicao_id)
  requisicao.estado = Requisicao::ACEITA
  requisicao.save!
end


Then /^eu devo ver na linha ([0-9]+) da tabela "([^\"]*)"$/ do |row, table_id, table_cells|
  hash = table_cells.hashes.first
  hash.keys.each_with_index do |header, col|
    within "##{table_id} tbody tr:nth-child(#{row}) td:nth-child(#{col+1})" do |scope|
      pass = false
      hash.keys.each do |each_header|
        begin
          scope.should contain(hash[each_header])
          pass = true
        rescue
        end
      end
      raise "#{header} is not in the cell ##{col+1} of the row ##{row} of the table\n#{scope}" unless pass
    end
  end
end

